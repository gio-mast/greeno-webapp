/**
 * Greeno WepApp - v1.27.0 2021-06-15
 *
 * Copyright (c) 2016 - 2021 Giovanni Mastrangelo
 * Licensed under the CC-BY-NC-ND-4.0 license.
 */

!function(){"use strict";!function(){let s=[],i,r,c,u,a,l,d,f,m,o={};const e="rsz-layout"+location.pathname.trim().replace(/\/$|(\/index)?\.[^\.]*$/gi,"").replace(/\//g,"-");function h(n,t,e,o){0==o.button&&(o.stopPropagation(),function(t,n){let e=t.t[n-1],o=t.t[n];for(;e&&e.n.classList.contains("fixed");)e=t.t[e.idx-1];for(;o&&o.n.classList.contains("fixed");)o=t.t[o.idx+1];return!(!e||!o)&&(i=e.n,r=o.n,c=e.e(),u=o.e(),a=t.e(),l=Math.max(e.o()-c,e.i()-c,u-o.c()),d=Math.min(u-o.o(),u-o.i(),e.c()-c),f=0,p(t),document.body.classList.add("resizing"),document.addEventListener("mouseup",g.bind(null,t)),!0)}(n,t)&&(m=e?function(t){1&t.buttons?w(t.clientY-o.clientY):v(n)}:function(t){1&t.buttons?w(t.clientX-o.clientX):v(n)},document.addEventListener("mousemove",m)))}function p(t){let e=[],o=0;t.t.forEach(function(t){t=t.e();e.push(t),o+=t}),o=o||1,t.t.forEach(function(t,n){n=100*e[n]/o;t.n.style.flex="1 1 "+n+"%"})}function w(t){(t=t<l?l:t)>d&&(t=d),i.style.flex="1 1 "+100*(c+t)/a+"%",r.style.flex="1 1 "+100*(u-t)/a+"%",t!==f&&(f=t,n(new CustomEvent("resize"),i,r))}function n(n){for(let t=arguments.length-1;1<=t;t--){const e=n;arguments[t].dispatchEvent(e),arguments[t].querySelectorAll(".rsz-panel").forEach(function(t){t.dispatchEvent(e)})}}function g(t,n){0==n.button&&v(t)}function v(t){document.removeEventListener("mousemove",m),document.removeEventListener("mouseup",g),function(t){if(t.u){let n=[];p(t),t.t.forEach(function(t){n.push(parseFloat(t.n.style.flexBasis))}),o[t.n.id]=n,window.localStorage.setItem(e,JSON.stringify(o))}}(t),document.body.classList.remove("resizing")}function b(t,n){const e=window.getComputedStyle(t).getPropertyValue("min-"+n);return-1!=e.lastIndexOf("px")?parseInt(e):0}function y(t,n){const e=window.getComputedStyle(t).getPropertyValue("max-"+n);return-1!=e.lastIndexOf("px")?parseInt(e):Number.POSITIVE_INFINITY}document.querySelectorAll(".rsz-container").forEach(function(e){const o=e.classList.contains("vertical"),i={n:e,u:e.id&&e.classList.contains("store"),t:[],e:o?function(){return this.n.offsetHeight}:function(){return this.n.offsetWidth}},r=document.createElement("DIV");r.classList.add("rsz-handle");for(let t=e.firstChild,n=0;null!=t;t=t.nextSibling){const c=t.classList;if(c&&c.contains("rsz-panel")){const u={idx:n,n:t};if(o?(u.e=function(){return this.n.offsetHeight},u.i=b.bind(null,t,"height"),u.c=y.bind(null,t,"height"),u.o=function(){return this.handle?this.handle.offsetHeight:0}):(u.e=function(){return this.n.offsetWidth},u.i=b.bind(null,t,"width"),u.c=y.bind(null,t,"width"),u.o=function(){return this.handle?this.handle.offsetWidth:0}),0<n){const a=r.cloneNode(!1);a.addEventListener("mousedown",h.bind(null,i,n,o)),t.appendChild(a),u.handle=a}i.t.push(u),n++}}s.push(i)}),function(){let n={};try{var t=window.localStorage.getItem(e);t&&(n=JSON.parse(t))}catch(t){}s.forEach(function(t){if(t.u){const e=n[t.n.id];e&&e.length===t.t.length&&(t.t.forEach(function(t,n){t.n.style.flex="1 1 "+e[n]+"%"}),o[t.n.id]=n[t.n.id])}t.n.classList.remove("store")}),window.localStorage.setItem(e,JSON.stringify(o))}(),window.addEventListener("resize",function(){n(new CustomEvent("resize"),document.body)}),document.body.classList.add("rsz-loaded")}();const d=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"],r=document.getElementById("graph"),l=document.getElementById("data-nav"),f=l.elements.area,m=l.elements.month,a=new function(t,n){const u=this,a=10,s=0;let l,d,f,m,h,p=[],w,g={top:0,bottom:-1};function v(){for(var t;t=l.firstChild;)l.removeChild(t)}this.fill=function(t,n){let e=t.columns;if(e instanceof Array){for(var o;o=d.firstChild;)d.removeChild(o);0<e.length&&(d.innerHTML="<tr><th>"+e.join("</th><th>")+"</th></tr>")}let i=t.rows;if(i instanceof Array){n||(p=[]);var r=i.length;for(let t=0;t<r;t++)p.push("<td>"+i[t].join("</td><td>")+"</td>");this.draw(!n)}},this.draw=function(t){var n=p.length,e=30*a,o=l.scrollTop;let i,r,c,u;if(r=0<n?(i=Math.max(0,(Math.floor(o/e)-1)*a),Math.min(n,(Math.ceil((o+w-30)/e)+1)*a)-1):(i=0,-1),t){for(c=g.top,u=g.bottom;c++<=u;)f.removeChild(m.nextSibling);c=i,u=r,u>=c&&m.insertAdjacentHTML("afterend","<tr>"+p.slice(c,u+1).join("</tr><tr>")+"</tr>")}else{if(g.top==i&&g.bottom==r)return;for(c=g.top,u=Math.min(g.bottom,i-1);c++<=u;)f.removeChild(m.nextSibling);for(c=Math.max(g.top,r+1),u=g.bottom;u-- >=c;)f.removeChild(h.previousSibling);c=i,u=Math.min(g.top-1,r),u>=c&&m.insertAdjacentHTML("afterend","<tr>"+p.slice(c,u+1).join("</tr><tr>")+"</tr>"),c=Math.max(g.bottom+1,i),u=r,u>=c&&h.insertAdjacentHTML("beforebegin","<tr>"+p.slice(c,u+1).join("</tr><tr>")+"</tr>")}m.style.height=30*i+"px",h.style.height=Math.max(30*(n-r-1),0)+"px",g.top=i,g.bottom=r},this.clearRows=function(){p=[],this.draw()},this.updateHeight=function(){var t=l.clientHeight;w!=t&&(w=t,u.draw())},this.scrollToRow=function(t){l.scrollTop=30*t},this.destroy=v,window.addEventListener("resize",this.updateHeight),function(t,n){let e,o;if(l="string"==typeof t?document.getElementById(t):t,!(l instanceof HTMLElement))throw"Datagrid container is undefined";v(),d=document.createElement("thead"),f=document.createElement("tbody"),e=document.createElement("table"),o=document.createElement("tr"),m=o.cloneNode(!1),m.style.visibility="hidden",h=m.cloneNode(!1);let i=s-1;for(o.style.display="none";0<i--;){if(a%s!=0)throw"if ROW_STYLE_CYCLE > 1 then ROWS_PER_BLOCK must be a multiple of ROW_STYLE_CYCLE";f.appendChild(o.cloneNode(!1))}f.appendChild(m),f.appendChild(h);let r=e.style;r.position="absolute",r.whiteSpace="nowrap",e.appendChild(d),e.appendChild(f);let c=l.style;c.position="relative",c.overflow="auto",c.padding="0",c.height=n||"400px",l.appendChild(e),l.addEventListener("scroll",function(){u.draw()},{capture:!0,passive:!0}),w=l.clientHeight}(t,n)}("grid","100%"),e=new function(t){const n=document.getElementById(t).dataset,e=[];function o(){var t=0==e.length;Array.prototype.push.apply(e,arguments),t&&0<e.length&&window.requestAnimationFrame(i)}function i(){n.state=e.shift()||"reset",e.length&&window.requestAnimationFrame(i)}this.show=function(){o("reset","growing")},this.hide=function(t){o(t?"0":"100")}}("progress-bar");var t,n,o;const c={xaxis:{type:"date",tickangle:0,rangeselector:{buttons:[{step:"day",stepmode:"todate",count:1,label:"≥00:00"},{step:"hour",stepmode:"backward",count:24,label:"24h"},{step:"hour",stepmode:"backward",count:48,label:"48h"},{step:"day",stepmode:"backward",count:7,label:"7g"},{step:"day",stepmode:"backward",count:15,label:"15g"},{step:"all",label:"[…]"}]},rangeslider:{},tickformatstops:[{dtickrange:[null,59999],value:"%H:%M:%S\n%-d %b '%y"},{dtickrange:[6e4,86399999],value:"%H:%M\n%-d %b '%y"},{dtickrange:[864e5,null],value:"%-d %b\n%Y"}]},yaxis:{fixedrange:!0},margin:{l:45,r:45,b:5},legend:{orientation:"h",x:0,y:-.6,xanchor:"left",yanchor:"top"}},u={displayModeBar:!0,displaylogo:!1,locale:"it"},h=new Intl.DateTimeFormat("it-IT",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});let p={},w=null,i;function s(){let e,o,i,r;const t=l.elements;e=t.area.value,o=t.month.value,i=t.type.value,r=t.raw.checked,this.makeUrl=function(t){let n=t+"?";return e&&(n+="area="+encodeURIComponent(e)+"&"),n+="month="+encodeURIComponent(o),n+="&type="+encodeURIComponent(i),r&&(n+="&raw=true"),n},this.revert=function(){t.area.value=e,t.month.value=o,t.type.value=i,t.raw.checked=r,E()}}function g(t,o){const i=new XMLHttpRequest;i.onreadystatechange=function(){if(4===i.readyState){var e=i.status;let t=null,n=(e<200||400<=e)&&e;0===e&&(n=!0);try{t=JSON.parse(i.responseText)}catch(t){n=!0}o(n,t)}},i.open("GET",t),i.send()}const v=0,b=1,y=2;let x=v;function z(t,n){x==y&&t==b&&(t=y),x==v&&t>v?(e.show(),M(!1)):x>v&&t==v&&(e.hide(n),M(!0)),x=t}function M(n){l.querySelectorAll("fieldset, select, button").forEach(function(t){t.disabled=!n}),E()}function k(){if(null!=w){const n=new Date;var t=w.timestamps;const e=new Date(1e3*t[t.length-1]);if(e.getUTCMonth()==n.getUTCMonth()&&e.getUTCFullYear()==n.getUTCFullYear())return void N(!1)}L()}function L(){z(y),g("json.php?list=all",function(t,n){t?(R(0,n),z(v,!0)):(p=n,S(),N(!1))})}function N(e){var t=f.value||0;if(z(b),void 0===p[t]||-1==p[t].indexOf(m.value))return z(v),w=null,void O(!1);const o=new s;g(o.makeUrl("json.php"),function(t,n){t?x==y||404!=t&&400!=t||!n||"area"!=n.param&&"month"!=n.param?(R(0,n),i&&i.revert(),z(v,!0)):L():(i=o,z(v),w=n,O(e))})}function R(t,n){n&&n.error&&console.error(n.error),window.alert("Impossibile soddisfare la richiesta, riprovare più tardi.")}function O(t){if(null===w)return document.body.classList.add("no-data"),l.elements.download.disabled=!0,void(l.elements["data-type"].disabled=!0);let e=[];w.timestamps.map(function(t){e.push(new Date(1e3*t))});const n=w.data,o=w.labels;let i=[];n.map(function(t,n){i.push({name:o[n],x:e,y:t,type:"scatter"})}),c.title=function(){var t=l.querySelector("input[name='type']:checked");let n;n=l.elements.raw.checked?t.dataset.raw:t.dataset.unit;return t.parentNode.textContent+(n?" ["+n+"]":"")}(),t||(c.xaxis.autorange=!0),Plotly.react(r,i,c,u),function(t,o,n,i){let e=["Data e ora"];n.map(function(t){e.push(t)});let r=[];var c=o.length;for(let e=t.length-1;0<=e;e--){let n=[h.format(t[e])];for(let t=0;t<c;t++){var u=o[t][e];n.push(null!==u?Number(u).toFixed(i):"")}r.push(n)}a.fill({columns:e,rows:r})}(e,n,o,w.decimals),t||a.scrollToRow(0),document.body.classList.remove("no-data"),l.elements.download.disabled=!1}function S(){const t=document.getElementById("area-control"),e=document.createElement("option"),n=Object.keys(p);let i=f.value||0,r=m.value,o=[];if(n.forEach(function(t){p[t].forEach(function(t){-1==o.indexOf(t)&&o.push(t)})}),o.sort(),!p[i]||-1==o.indexOf(r)){let e=0,o="";n.forEach(function(n){p[n].forEach(function(t){t>o&&(o=t,e=n)})}),i=e,r=o}C(f),C(m),n.length<2?t.hidden=!0:(t.hidden=!1,n.map(function(t){const n=e.cloneNode(!1);n.textContent=t,n.value=t,n.selected=t==i,f.add(n)}));const c=p[i];for(let t=o.length-1;0<=t;t--){var u=o[t];const l=e.cloneNode(!1);l.value=u,l.textContent=(s=void 0,s=(a=u).substring(0,4),(a=d[parseInt(a.substring(4))-1])+" "+s),l.selected=u==r,l.disabled=!c||-1==c.indexOf(l.value),m.add(l)}var a,s}function C(n){for(let t=n.options.length-1;0<=t;t--)n.remove(t)}function E(){var t=null===l.querySelector("input[data-raw]:checked");t&&(l.elements.raw.checked=!1),l.elements.raw.disabled=t}function I(){if(null!==w){var o=w.data,i=w.timestamps,r=w.decimals,n=w.labels.join('","');let e='"Data e ora"'+(""!==n?',"'+n+'"\n':"\n");var c=i.length,u=o.length;for(let n=0;n<c;n++){e+='"'+h.format(new Date(1e3*i[n]))+'"';for(let t=0;t<u;t++){var a=o[t][n];e+=","+(null!==a?Number(a).toFixed(r):"")}e+="\n"}n=l.elements;let t="";n.area.value&&(t=n.area.value+"-"),t+=n.month.value+"-"+n.type.value,n.raw.checked&&(t+="-raw"),t+=".csv";n=new Blob([e],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(n,t);else{const s=document.createElement("a");void 0!==s.download&&(n=URL.createObjectURL(n),s.href=n,s.download=t,s.hidden=!0,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n))}}}function D(t){let n;return function(){n&&clearTimeout(n),n=setTimeout(t,300)}}function T(){p=JSON.parse(document.getElementById("data-lists").textContent),S();const t=document.createElement("span");t.textContent="Nessun dato da visualizzare",t.classList.add("no-data-message"),r.parentNode.appendChild(t),document.getElementById("grid").parentNode.appendChild(t.cloneNode(!0)),l.addEventListener("change",function(t){let n=!0;t.target===f?function(){const n=p[f.value||0];var e=m.options;for(let t=e.length-1;0<=t;t--){const o=e[t];n?o.disabled=-1==n.indexOf(o.value):disabled=!0}}():t.target===m?n=!1:"type"===t.target.name&&E(),N(n)}),l.elements.refresh.addEventListener("click",k),l.elements.download.addEventListener("click",I),document.getElementById("grid-panel").addEventListener("resize",D(a.updateHeight)),document.getElementById("graph-panel").addEventListener("resize",D(function(){Plotly.relayout(r,{width:r.offsetWidth,height:r.offsetHeight})})),N(!1)}"undefined"!=typeof RadioNodeList&&"undefined"!==RadioNodeList.value&&window.NodeList&&NodeList.prototype.forEach&&"function"==typeof window.CustomEvent?T():(t="assets/polyfills.js",n=T,(o=document.createElement("script")).src=t,o.onload=function(){n()},o.onerror=function(){n(new Error("Failed to load script "+t))},document.head.appendChild(o))}();